image: maven:3.3.9

pipelines:
  branches:
    develop:
    - step:
        name: Verify Backend Maven Build
        caches:
        - maven
        script: # mvn verify runs mvn tests and makes sure everything builds as expected
        - mvn -B verify -f  backend/pom.xml -P prod # -B batch mode makes Maven less verbose
    - step:
        name: Verify Mail Maven Build
        caches:
        - maven
        script: # mvn verify runs mvn tests and makes sure everything builds as expected
        - mvn -B verify -f  mail/pom.xml -P prod # -B batch mode makes Maven less verbose
    - step:
        name: Build Management App
        image: node:10
        caches:
        - node
        script:
        - rm management-app/package-lock.json
        - npm install --prefix management-app
        - npm run build --prefix management-app
    master:
    - step:
        name: Build Backend
        caches:
        - maven
        script: # mvn verify runs mvn tests and makes sure everything builds as expected
        - mvn -B clean package -f  backend/pom.xml -P prod # -B batch mode makes Maven less verbose
        artifacts:
        - backend/target/**
    - step:
        name: Build Mail
        caches:
        - maven
        script: # mvn verify runs mvn tests and makes sure everything builds as expected
        - mvn -B clean package -f  mail/pom.xml -P prod # -B batch mode makes Maven less verbose
        artifacts:
        - mail/target/**
    - step:
        name: Build Management App
        image: node:10
        caches:
        - node
        script:
        - rm management-app/package-lock.json
        - npm install --prefix management-app
        - npm run build:prod --prefix management-app
        artifacts:
        - management-app/www/**
    - step:
        name: Deploy App and Backend
        script:
            - tar -zcf app.tar management-app/www/*
            - ssh fthielen@116.203.29.171 'rm -r -f /home/fthielen/immoapps_infrastructure/nginx/html/management-app/www/*'
            - scp -r app.tar fthielen@116.203.29.171:/home/fthielen/immoapps_infrastructure/nginx/html
            - ssh fthielen@116.203.29.171 'cd /home/fthielen/immoapps_infrastructure/nginx/html && tar -xvf app.tar'
            - scp backend/target/immoapps.jar fthielen@116.203.29.171:/home/fthielen/immoapps_infrastructure/springboot/data/immoapps.jar
            - scp mail/target/immoappsmail.jar fthielen@116.203.29.171:/home/fthielen/immoapps_infrastructure/springbootmail/data/immoappsmail.jar
            - ssh fthielen@116.203.29.171 '/home/fthielen/immoapps_infrastructure/run.sh'
     