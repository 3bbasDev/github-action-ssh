<ion-header>
  <ion-toolbar>
    <app-editable [component]="'TITLE'" (save)="changeTitle($event)" #title [title]="checklistInstance?.name">
      <ion-chip (click)="undefaultConfirm()" *ngIf="checklistInstance?.defaultChecklist && !property" color="primary">
        <ion-label>Als Standard festgelegt</ion-label>
        <ion-icon name="md-close"></ion-icon>
      </ion-chip>
    </app-editable>
    <!-- <ion-title>{{checklistInstance?.name}} <span *ngIf="property">(in {{property.name}})</span> bearbeiten</ion-title> -->
    <ion-buttons slot="start" *ngIf="currentUser as u">
      <ion-back-button *fivPermissions="['ROLE_HAUSVERWALTER','ROLE_MITARBEITER']; userPermissions [u.role]"
        defaultHref="checklists"></ion-back-button>
      <ion-back-button *fivPermissions="['ROLE_ADMIN']; userPermissions [u.role]" defaultHref="admin-checklists">
      </ion-back-button>
    </ion-buttons>

    <fiv-buttons slot="end" [count]="2">
      <fiv-button *ngIf="title.editing" [icon]="'md-save'" [disabled]="!title.isValid()" (click)="changeTitle(title)"
        [matTooltip]="'Änderungen speichern'">
      </fiv-button>

      <fiv-button *ngIf="!title.editing" [icon]="'ios-arrow-down'" matTooltip="Alle Prüfbereiche öffnen"
        (click)="openAll()">
      </fiv-button>

      <fiv-button *ngIf="!title.editing" [icon]="'ios-arrow-up'" matTooltip="Alle Prüfbereiche schließen"
        (click)="closeAll()">
      </fiv-button>

      <fiv-button [text]="'Checkliste umbenennen'" *ngIf="!title.editing" [icon]="'md-create'" (click)="title.edit()"
        [matTooltip]="'Checkliste umbenennen'">
      </fiv-button>

      <fiv-button [icon]="'md-close'" *ngIf="title.editing" (click)="title.reset()"
        [matTooltip]="'Änderungen verwerfen'">
      </fiv-button>

      <fiv-button (click)="default()" [icon]="'md-attach'"
        *ngIf="!title.editing && !checklistInstance?.defaultChecklist && !property" [text]="'Als Standard markieren'">
      </fiv-button>
      <fiv-button [icon]="'md-trash'" *ngIf="!title.editing" (click)="presentAlertConfirm()"
        [text]="'Checkliste löschen'">
      </fiv-button>

    </fiv-buttons>
  </ion-toolbar>
</ion-header>

<ion-content padding *ngIf="currentUser as u">

  <ion-grid fixed>
    <ion-row>
      <ion-col size="12">
        <app-breadcrumb *fivPermissions="['ROLE_HAUSVERWALTER','ROLE_MITARBEITER']; userPermissions [u.role]"></app-breadcrumb>
        <div *ngIf="checklistInstance?.levels.length == 0">
          Noch keine Prüfbereiche angelegt. Bearbeiten Sie die Checkliste um Prüfbereiche hinzuzufügen.
        </div>

        <fiv-stepper (fivClick)="stepClick($event,stepper)" (fivClose)="stepClose($event,stepper)" #stepper>
          <fiv-step [title]="level.name"
            [subtitle]="level.kriterien.length == 0 ? 'Noch keine Prüfkriterien angelegt': level.kriterien.length > 1 ? level.kriterien.length + ' Prüfkriterien' : '1 Prüfkriterium'"
            *ngFor="let level of checklistInstance?.levels; let i = index;">
            <level [property]="property" (kriteriumChanged)="kriteriumChanged($event)"
              [isAdmin]="u.role === 'ROLE_ADMIN'" (kriteriumDeleted)="kriteriumDeleted($event)"
              [categories]="categories" (checklistChanged)="checklistChanged($event)"
              (kriteriumAdded)="kriteriumAdded($event)" [checklist]="checklistInstance" [level]="i"></level>
          </fiv-step>
          <fiv-step [icon]="'md-add'" [title]="'Prüfbereich hinzufügen'">
            <ion-card>
              <fiv-loading-progress-bar (fivComplete)="levelAddComplete($event,stepper)" #bar>
              </fiv-loading-progress-bar>
              <ion-card-content>
                <form [formGroup]="addLevelForm">
                  <ion-item>
                    <ion-label position="floating">Name des Prüfbereichs</ion-label>
                    <ion-input formControlName="name" type="text"></ion-input>
                  </ion-item>
                </form>
              </ion-card-content>
              <ion-toolbar color="translucent">
                <ion-buttons slot="end">
                  <ion-button [disabled]="addLevelForm.invalid" (click)="addLevel(bar,stepper)">
                    {{addLevelForm?.value.name}} erstellen
                  </ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-card>
          </fiv-step>
        </fiv-stepper>
      </ion-col>
    </ion-row>
  </ion-grid>


</ion-content>