<ion-header>
  <ion-toolbar>
    <ion-title>Inspektion anlegen</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content padding>

  <ion-grid fixed>
    <ion-row>
      <ion-col size="12">
        <app-breadcrumb></app-breadcrumb>
        <form [formGroup]="inspectionForm">
          <fiv-stepper (fivClick)="onStepClicked($event)">
            <fiv-step [title]="'Immobilie auswählen'" [subtitle]="'Bitte wählen Sie zunächst eine Immobilie aus'"
              [open]="true">
              <ion-card>
                <fiv-loading-progress-bar (fivComplete)="usersLoaded()" #propertyBar></fiv-loading-progress-bar>
                <ion-card-header>
                  <ion-card-subtitle>Bitte wählen Sie zunächst eine Immobilie aus</ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                  <ion-select cancelText="Abbrechen" okText="Weiter" formControlName="propertyId" multiple="false"
                    placeholder="Immobilie auswählen">
                    <ion-select-option *ngFor="let property of properties | async" [value]="property.id">
                      {{property.name}} ({{property.address}})
                    </ion-select-option>
                  </ion-select>

                </ion-card-content>
                <ion-toolbar>
                  <ion-buttons slot="end">
                    <ion-button [disabled]="property.invalid" (click)="loadUsers(propertyBar)">
                      Weiter
                    </ion-button>
                  </ion-buttons>
                </ion-toolbar>
              </ion-card>
            </fiv-step>
            <fiv-step [title]="'Hausmeister auswählen'"
              [subtitle]="'Wählen Sie den Hausmeister aus, der die Inspektion durchführen soll'">
              <ion-card>
                <fiv-loading-progress-bar (fivComplete)="criteriasLoaded()" #userBar></fiv-loading-progress-bar>
                <ion-card-header>
                  <ion-card-subtitle>Wählen Sie den Hausmeister aus, der die Inspektion durchführen soll
                  </ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                  <ion-select cancelText="Abbrechen" okText="Weiter" formControlName="userId" multiple="false"
                    placeholder="Hausmeister auswählen">
                    <ion-select-option *ngFor="let user of users | async" [value]="user.id">
                      {{user.firstname}} {{user.lastname}}
                    </ion-select-option>
                  </ion-select>
                </ion-card-content>
                <ion-toolbar>
                  <ion-buttons slot="end">
                    <ion-button [disabled]="user.invalid" (click)="loadCriterias(userBar)">
                      Weiter
                    </ion-button>
                  </ion-buttons>
                </ion-toolbar>
              </ion-card>
            </fiv-step>
            <fiv-step [title]="'Prüfpunkte auswählen'" [subtitle]="'Ordnen Sie der Inspektion Prüfpunkte zu'">
              <ion-card *ngIf="checklists">
                <fiv-loading-progress-bar (fivComplete)="onDone()" #inspectionBar></fiv-loading-progress-bar>
                <ion-card-header>
                  <ion-card-subtitle>Wählen Sie die Prüfpunkte für die Inspektion aus</ion-card-subtitle>
                  <ion-chip [color]="kriterien.value.length === 0 ? 'danger' : 'primary'">
                    <ion-label>{{kriterien.value.length}} Prüfpunkte ausgewählt</ion-label>
                  </ion-chip>
                </ion-card-header>
                <ion-card-content>
                  <mat-tab-group (selectedTabChange)="tabChange($event)" mat-align-tabs="center">
                    <mat-tab>
                      <ng-template matTabLabel>
                        <span [matBadge]="(checklists | async)?.length" matBadgeOverlap="false">Checklisten</span>
                      </ng-template>
                      <ng-container>
                        <ion-list>
                          <app-checklist (removeKriterien)="removeKriterien($event)"
                            (addKriterien)="addKriterien($event)" [first]="f" [last]="l"
                            *ngFor="let checklist of checklists | async; let l = last; let f = first"
                            [checklist]="checklist"></app-checklist>
                        </ion-list>
                      </ng-container>
                    </mat-tab>
                    <mat-tab>
                      <ng-template matTabLabel>
                        <span [matBadge]="(criterias | async)?.length" matBadgeOverlap="false">Prüfpunkte</span>
                      </ng-template>
                      <ng-container>
                        <app-kriterium-select (change)="kriteriumChanged($event,krit)" [kriterium]="krit"
                          *ngFor="let krit of criterias | async">

                        </app-kriterium-select>
                      </ng-container>
                    </mat-tab>
                  </mat-tab-group>
                  <fiv-expandable #ex [isOpen]="taskRule === 'SCHEDULED'">
                    <div content>
                      <app-task-create></app-task-create>
                    </div>
                  </fiv-expandable>
                </ion-card-content>
                <ion-toolbar>
                  <ion-buttons slot="end">
                    <ion-select cancelText="Abbrechen" okText="Auswählen" multiple="false"
                      (ionChange)="taskRuleChanged($event)">
                      <ion-select-option selected value="ONCE">Einmalige Inspektion</ion-select-option>
                      <ion-select-option value="SCHEDULED">Wiederkehrende Inspektion</ion-select-option>
                    </ion-select>
                    <ion-button
                      [disabled]="(taskRule === 'ONCE' && inspectionForm.invalid) || (taskRule === 'SCHEDULED' && (inspectionForm.invalid || taskComponent.schedule.invalid))"
                      (click)="submit(inspectionBar)">
                      Inspektion anlegen
                    </ion-button>
                  </ion-buttons>
                </ion-toolbar>
              </ion-card>
            </fiv-step>
          </fiv-stepper>
        </form>

      </ion-col>
    </ion-row>
  </ion-grid>

</ion-content>