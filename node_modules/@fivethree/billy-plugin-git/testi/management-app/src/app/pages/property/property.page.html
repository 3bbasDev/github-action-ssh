<ion-header>
  <ion-toolbar>
    <ion-title>{{(property | async)?.name}}</ion-title>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/properties"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content padding>

  <ion-grid fixed>
    <ion-row>
      <ion-col size="12">
        <app-breadcrumb></app-breadcrumb>
        <ion-card *ngIf="(property | async) as prop">
          <ion-toolbar>
            <ion-title>{{prop?.name}}</ion-title>
            <fiv-buttons slot="end" [count]="1">
              <fiv-button [icon]="'md-create'" [matTooltip]="prop?.name +  ' bearbeiten'" (click)="editProperty(prop)">
              </fiv-button>
              <fiv-button (click)="confirmDeletion(prop)" [icon]="'md-trash'" [text]="'Immobilie löschen'">
              </fiv-button>
            </fiv-buttons>
          </ion-toolbar>
          <ion-card-content class="no-lines">
            <ion-list>
              <ion-item lines>
                <ion-label slot="start">
                  Name
                </ion-label>
                <div slot="end">
                  {{prop?.name}}
                </div>
              </ion-item>
              <ion-item lines>
                <ion-label slot="start">
                  Adresse
                </ion-label>
                <div slot="end">
                  {{prop?.address}}
                </div>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <ion-card *ngIf="(property | async) as prop">
          <ion-toolbar>
            <ion-title>Checklisten in {{prop?.name}}</ion-title>
            <fiv-buttons [text]="'Checkliste hinzufügen'" [matTooltip]="'Checkliste in ' + prop?.name + ' erstellen'"
              #buttons [header]="'Checkliste hinzufügen'" [count]="0" slot="end">
              <fiv-button (click)="link(c,prop)" *ngFor="let c of allChecklists" [text]="c.name">
              </fiv-button>
            </fiv-buttons>
          </ion-toolbar>
          <ion-list class="no-lines">
            <ion-item (click)="navigateToChecklist(prop,checklist)" class="highlight" *ngFor="let checklist of selectedChecklists">
              <ion-label>
                {{checklist.name}}
              </ion-label>
              <div slot="end">
                {{checklist.levels?.length}} Prüfbereiche
              </div>
            </ion-item>
            <ion-item *ngIf="selectedChecklists?.length === 0">
              <ion-label>Noch keine Checklisten erstellt</ion-label>
              <ion-button (click)="buttons.presentPopover($event)">
                Checkliste in {{prop?.name}} erstellen
              </ion-button>
            </ion-item>
          </ion-list>
        </ion-card>

        <ion-card *ngIf="(property | async) as prop">
          <fiv-loading-progress-bar (fivComplete)="changeUsersComplete($event)" #userBar></fiv-loading-progress-bar>
          <ion-toolbar>
            <ion-title>Zugeordnete Benutzer von {{prop?.name}}</ion-title>
            <ion-buttons matTooltip="Benutzer zuweisen" slot="end">
              <ion-button slot="end" (click)="selectUsers.open()">
                Benutzer zuweisen
              </ion-button>
            </ion-buttons>

          </ion-toolbar>
          <ion-card-content>
            <ion-item id="select">
              <mat-select [compareWith]="compareUser" [(ngModel)]="selectedUsers"
                (openedChange)="selectUserChanged($event,prop,userBar)" #selectUsers placeholder="Benutzer auswählen"
                multiple>
                <mat-option *ngFor="let u of allUsers | async" [value]="u">{{u.firstname}} {{u.lastname}} ({{u.email}})
                </mat-option>
              </mat-select>
            </ion-item>
            <ion-chip (click)="navigateToUser(user)" *ngFor="let user of propertyUsers">
              <ion-label>{{user.firstname}} {{user.lastname}}</ion-label>
            </ion-chip>
            <ion-item *ngIf="propertyUsers?.length === 0">
              <ion-label>Noch keine Hausmeister zugeordnet</ion-label>
            </ion-item>
          </ion-card-content>
        </ion-card>
        <ion-card>
          <ion-toolbar>
            <ion-title>Begehungen</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="navigateToInspections()">
                Alle ansehen
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
          <ion-card-content>
            <table mat-table [dataSource]="dataSource" class="mat-elevation-z0" #inspectionsSort="matSort" matSort>

              <ng-container matColumnDef="userId">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Durchgeführt von</th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="(element.userId | userByID : (allUsers | async)) as u">
                    {{u.firstname}} {{u.lastname}}
                  </ng-container>
                </td>
              </ng-container>
              <ng-container matColumnDef="criterias">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Prüfpunkte</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.criterias.length == 1 ? '1 Prüfpunkt' : element.criterias.length + '
                      Prüfpunkte'}}</td>
              </ng-container>
              <ng-container matColumnDef="results">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Ergebnisse</th>
                <td mat-cell *matCellDef="let element"> {{ element.results.length == 1 ? '1 Ergebnis' :
                      element.results.length + '
                      Ergebnisse'}}</td>
              </ng-container>

              <ng-container matColumnDef="done">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Abgeschlossen</th>
                <td mat-cell *matCellDef="let element">
                  {{element.done ? 'abgeschlossen' : 'offen'}}
                </td>
              </ng-container>



              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="navigateToInspection(row)"></tr>
            </table>
            <mat-paginator #inspectionsPager [pageSizeOptions]="[15, 30, 50, 100]" showFirstLastButtons></mat-paginator>
          </ion-card-content>
        </ion-card>
        <ion-card *ngIf="property | async as p">
          <ion-toolbar>
            <ion-title>Wiederkehrende Inspektionen</ion-title>
          </ion-toolbar>
          <ion-card-content>
            <table mat-table [dataSource]="taskSource" class="mat-elevation-z0" #tasksSort="matSort" matSort>
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
                <td mat-cell *matCellDef="let element">
                  <ng-container>
                    {{element.name}}
                  </ng-container>
                </td>
              </ng-container>
              <ng-container matColumnDef="userId">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Durchzuführen von</th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="(element.userId | userByID : (allUsers | async)) as u">
                    {{u.firstname}} {{u.lastname}}
                  </ng-container>
                </td>
              </ng-container>
              <ng-container matColumnDef="pruefkriterien">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Prüfpunkte</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.pruefkriterien.length == 1 ? '1 Prüfpunkt' : element.pruefkriterien.length + '
                        Prüfpunkte'}}</td>
              </ng-container>

              <ng-container matColumnDef="rule">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Regel</th>
                <td mat-cell *matCellDef="let element">
                  {{element.scheduleOption.name}}
                </td>
              </ng-container>
              <ng-container matColumnDef="startDate">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Startdatum</th>
                <td mat-cell *matCellDef="let element">
                  {{element.startDate}}
                </td>
              </ng-container>
              <ng-container matColumnDef="active">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                <td mat-cell *matCellDef="let element">
                  {{element.active ? 'Aktiviert' : 'Deaktiviert'}}
                </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="taskColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: taskColumns;" (click)="navigateToTask(row,p)"></tr>
            </table>
            <mat-paginator #tasksPager [pageSizeOptions]="[15, 30, 50, 100]" showFirstLastButtons></mat-paginator>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>