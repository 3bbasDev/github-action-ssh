default_platform(:ios)

platform :ios do
  desc "Push alpha build to testflight"
  lane :alpha do |options|
    # ensure_git_status_clean
    match(type: "appstore")
    version_and_build_no = fiv_version(ios: true, pathToConfigXML: "./config.xml")
    
    outputpath = fiv_ionic(
      platform: "ios",
      release: "true",
      prod: "true",
      team_id: "3U4XHL3NFH"
    )

    automatic_code_signing(
      path: "./platforms/ios/immoapp.xcodeproj",
      use_automatic_signing: false
    )

    gym(
    project: "./platforms/ios/immoapp.xcodeproj",
    configuration: "Release"
    )

    pilot
    UI.success "Successfully built and delivered app for alpha track! :)"

  end

  desc "Produce app"
  lane :produce_immoapp do |options|

    username = CredentialsManager::AppfileConfig.try_fetch_value(:apple_id)
    app_identifier = CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier)
    produce(
      username: "#{username}",
      app_identifier: "#{app_identifier}",
      app_name: "immoapp GmbH",
      language: "German",
      app_version: "0.0.1",
      sku: "#{app_identifier}",
    )
  end
end

platform :android do

  desc "Push alpha build to play store alpha track"
  lane :alpha do |options|
  # ensure_git_status_clean
  version_and_build_no = fiv_version(ios: false, pathToConfigXML: "./config.xml")
  outputpath = fiv_ionic(
    platform: "android",
    release: "true",
    prod: "true"
  )
  signedApk = fiv_sign_android(
    output_directory: "./.android_signing",
    keystore_name: "immoapp",
    alias: "immoapp",
    version: "#{version_and_build_no[:version]}",
    build_no: "#{version_and_build_no[:build_no]}",
    silent: true
  )

  app_identifier = CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier)

  supply(
  apk: "#{signedApk}",
  track: "alpha",
  package_name: "#{app_identifier}",
  json_key: "./google-service-account.json",
  skip_upload_apk: false,
  skip_upload_metadata: true,
  skip_upload_images: true,
  skip_upload_screenshots: true
  )

  UI.success "Successfully finished built android alpha apk: #{signedApk}"

  end

end
