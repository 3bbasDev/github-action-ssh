package de.fivethree.immoapps.backend.service;

import de.fivethree.immoapps.backend.domain.inspection.Inspection;
import de.fivethree.immoapps.backend.domain.inspection.InspectionImage;
import de.fivethree.immoapps.backend.domain.inspection.InspectionResult;
import de.fivethree.immoapps.backend.domain.user.User;
import de.fivethree.immoapps.backend.exceptions.FTLReplacementException;
import de.fivethree.immoapps.backend.exceptions.PDFReportCreationException;
import de.fivethree.immoapps.backend.model.report.InspectionCriteriaReportModel;
import de.fivethree.immoapps.backend.model.report.InspectionDescriptionReportModel;
import de.fivethree.immoapps.backend.model.report.InspectionImageReportModel;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.*;

@Service
public class ReportService {
    @Autowired
    private FTLReplacementService ftlReplacementService;

    @Autowired
    private PDFReportService pdfReportService;


    public byte[] generateInspectionReport(Inspection inspection) {

        String pageTitle = inspection.getProperty().getName();
        String propertyName = inspection.getProperty().getName();
        String propertyAddress = inspection.getProperty().getFullAddress();
        String userName = inspection.getUser().getFullName();
        String userEmail = inspection.getUser().getEmail();

        String companyName = null;
        String companyStreetAndNo = null;
        String companyPlace = null;
        String companyZip = null;

        User hausverwalter = inspection.getProperty().getHausverwalter();

        if (hausverwalter.getAdditionalUserInfo() != null
                && hausverwalter.getAdditionalUserInfo().getCompanyName() != null
                && !hausverwalter.getAdditionalUserInfo().getCompanyName().trim().isEmpty()) {
            companyName = hausverwalter.getAdditionalUserInfo().getCompanyName();
            companyPlace = hausverwalter.getAdditionalUserInfo().getCity();
            companyStreetAndNo = hausverwalter.getAdditionalUserInfo().getStreetAndNo();
            companyZip = hausverwalter.getAdditionalUserInfo().getZip();
        }


        List<InspectionCriteriaReportModel> criterias = new ArrayList<>();
        List<InspectionImageReportModel> images = new ArrayList<>();
        List<InspectionDescriptionReportModel> descriptions = new ArrayList<>();

        for (InspectionResult inspectionResult : inspection.getInspectionResults()) {
            String criteriaName = inspectionResult.getPruefkriterium().getName();

            criterias.add(new InspectionCriteriaReportModel(criteriaName,
                    inspectionResult.getResult() == true ? "ok" : "not ok"));

            if (inspectionResult.getDescription() != null && !inspectionResult.getDescription().trim().isEmpty()) {
                descriptions.add(new InspectionDescriptionReportModel(criteriaName,
                        inspectionResult.getDescription()));
            }

            for (InspectionImage image : inspectionResult.getImages()) {
                images.add(new InspectionImageReportModel(criteriaName, image.getType(),
                        Base64.getEncoder().encodeToString(image.getData())));
            }
        }


        Map<String, Object> props = new HashMap<>();
        props.put("pageTitle", pageTitle);
        props.put("propertyName", propertyName);
        props.put("propertyAddress", propertyAddress);
        props.put("userName", userName);
        props.put("userEmail", userEmail);
        props.put("criterias", criterias);
        props.put("descriptions", descriptions);
        props.put("images", images);
        props.put("companyName", companyName);
        props.put("companyPlace", companyPlace);
        props.put("companyStreetAndNo", companyStreetAndNo);
        props.put("companyZip", companyZip);

        String html = ftlReplacementService.getReplacedFTLFile("index.ftl",
                "/pdfreports/inspection/", props);

        return pdfReportService.generatePDFReportFromHTMLContent(html, "src/main/resources/pdfreports/inspection",
                "src/main/resources/pdfreports/inspection");
    }




}
